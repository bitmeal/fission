name: Run Tests

# do not run automatically
on:
  workflow_call:
  workflow_dispatch:


jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [alpine, debian, ubuntu, opensuse , fedora, redhat-ubi8, almalinux, rockylinux]
        init:     [true, false]
        arch:     [amd64, arm64]
        experimental: [false]
        include:
          - platform: amazonlinux
            init: [true, false]
            arch: [amd64, arm64]
            experimental: true
    continue-on-error: ${{ matrix.experimental }}
    env:
      FISSION_DOCKER_INIT: ${{ matrix.init }}
    services:
      registry:
        image: registry:2
        ports:
          - 5000:5000
    steps:
    - 
      name: Fetch Dependencies
      run: sudo apt install -qq -y jq moreutils
    - 
      name: Clone
      uses: actions/checkout@v2
    - 
      name: Set up QEMU
      uses: docker/setup-qemu-action@v1
    - 
      name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1
      with:
          driver-opts: network=host
    - 
      # allow step to fail; image will not be reused but be built locally
      name: Fetch and restore buildx cache from artifact
      uses: actions/download-artifact@v2
      with:
        name: buildx-cache-${{ hashFiles('Dockerfile') }}
        path: /tmp/buildx-cache
    -
      name: Rebuild base images for [amd64][arm64] from CACHE and push to local registry
      uses: docker/build-push-action@v2
      with:
        context: .
        tags: localhost:5000/fission/fission:base
        platforms: linux/amd64,linux/arm64
        cache-from: type=local,src=/tmp/buildx-cache
        push: true
    -
      name: "Build and load test image: [${{ matrix.platform }}][${{ matrix.arch }}]"
      uses: docker/build-push-action@v2
      with:
        context: ./test/platforms/${{ matrix.platform }}
        build-args: FISSION_BASE=localhost:5000/fission/fission:base
        tags: fission:${{ matrix.platform }}
        platforms: linux/${{ matrix.arch }}
        load: true
    - 
      name: Run Tests [amd64]
      if: ${{ matrix.platform  != 'arm64' }}
      working-directory: test
      env:
        FISSION_PLATFORM: ${{ matrix.platform }}
      run: ./test.bash -t
    - 
      name: Run tests [arm64]
      if: ${{ matrix.platform  == 'arm64' }}
      uses: uraimo/run-on-arch-action@v2.1.1
      with:
        env: |
          FISSION_PLATFORM: ${{ matrix.platform }}
        arch: aarch64
        distro: ubuntu20.04
        run: |
          cd test
          ./test.bash -t
    - 
      name: "Prepare status artifact [${{ matrix.platform }}][init: ${{ matrix.init }}][arch: ${{ matrix.arch }}] ([status_${{ matrix.arch }}_init-${{ matrix.init }}])"
      if: ${{ always() }}
      run: |
        mkdir -p status &&
        echo '{}' | jq --arg job "${{ matrix.platform }}" '. + {job: $job}' > status/${{ matrix.platform }}.json
    - 
      name: Finalize status artifact @success
      if: ${{ success() }}
      run: |
        cat status/${{ matrix.platform }}.json | jq --argjson success true '. + {success: $success}' | sponge status/${{ matrix.platform }}.json
    - 
      name: Finalize status artifact @failure
      if: ${{ failure() }}
      run: |
        cat status/${{ matrix.platform }}.json | jq --argjson success false '. + {success: $success}' | sponge status/${{ matrix.platform }}.json
    - 
      name: Add ${{ matrix.platform }}.json to status artifact [status_${{ matrix.arch }}_init-${{ matrix.init }}]
      if: ${{ !cancelled() }}
      uses: actions/upload-artifact@v2
      with:
        name: status_${{ matrix.arch }}_init-${{ matrix.init }}
        path: status/




